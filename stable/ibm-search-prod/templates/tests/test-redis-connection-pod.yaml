# Licensed Materials - Property of IBM
# @ Copyright IBM Corporation 2016, 2019. All Rights Reserved.
# US Government Users Restricted Rights - Use, duplication or disclosure restricted by GSA ADP Schedule Contract with IBM Corp.

apiVersion: v1
kind: Pod
metadata:
  labels:
    app: {{ template "search.fullname" . }}-redis-test
    component: "search"
    release: {{ .Release.Name }}
    chart: {{ template "search.chart" . }}
    heritage: {{ .Release.Service }}
  name: {{ template "search.fullname" . }}-redis-test
  annotations:
    "helm.sh/hook": test-success
spec:
  imagePullSecrets:
    - name: {{ .Values.global.pullSecret }}
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: beta.kubernetes.io/arch
            operator: In
            values:
            {{- range .Values.global.arch }}
            - {{ . }}
            {{- end }}
          - key: management
            operator: In
            values:
            - "true"  
  hostPID: false
  hostIPC: false
  hostNetwork: false
  containers:
    - name: "{{ template "search.fullname" . }}-redis-test"
      image: {{ .Values.search.redisgraph.image.repository }}:{{ .Values.search.redisgraph.image.tag }}
      imagePullPolicy: {{ .Values.search.redisgraph.image.pullPolicy }}
      securityContext:
        runAsUser: 0
        runAsNonRoot: false
        capabilities:
          drop:
          - ALL
      command:  ["/bin/bash","-c", "/rediscert/runTests.sh"]
      volumeMounts:
        - name: redis-graph-certs
          mountPath: /rediscert/redis.crt
          subPath: redis.crt
        - name: stunnel-config
          mountPath: /rediscert/test-stunnel.conf
          subPath: test-stunnel.conf
        - name: stunnel-config
          mountPath: /rediscert/runTests.sh
          subPath: runTests.sh      
      resources:
            requests:
              memory: "64Mi"
              cpu: "25m"
            limits:
              memory: "512Mi"
              cpu: "50m" 
      env:
        - name: REDIS_HOST
          value: '{{ template "search.fullname" . }}-search-redisgraph'
        - name: REDIS_SSH_PORT
          value: "6380"
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: {{ .Release.Name }}-redisgraph-user-secrets
              key: redispwd           
  volumes:
    - name: redis-graph-certs
      secret:
        secretName: {{ .Release.Name }}-redisgraph-secrets
        items:
        - key: ca.crt
          path: redis.crt
        - key: tls.crt
          path: server.crt
        - key: tls.key
          path: server.key
    - name: stunnel-config
      configMap:
        name: {{ template "search.fullname" . }}-test-stunnel
        defaultMode: 0755       
  restartPolicy: Never