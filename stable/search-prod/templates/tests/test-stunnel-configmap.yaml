# Licensed Materials - Property of IBM
# (C) Copyright IBM Corporation 2019 All Rights Reserved
# US Government Users Restricted Rights - Use, duplication or disclosure restricted by GSA ADP Schedule Contract with IBM Corp.

apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    app: {{ template "search.fullname" . }}-test-stunnel
    chart: {{.Chart.Name}}-{{.Chart.Version}}
    heritage: {{ .Release.Service }}
    release: {{ .Release.Name }}
  name: {{ template "search.fullname" . }}-test-stunnel
  annotations:
    "helm.sh/hook-delete-policy": hook-succeeded
data:
  test-stunnel.conf: |
    debug = 7
    output = /tmp/st.log
    pid = /tmp/st.pid
    [redis-cli]
    client=yes
    accept=6667
    connect={{ template "search.fullname" . }}-search-redisgraph:6380
    verify=2
    CAfile=/rediscert/redis.crt
  runTests.sh: |
    #!/bin/sh
    stunnel /rediscert/test-stunnel.conf
    test_result=$(redis-cli -p 6667 -a $REDIS_PASSWORD ping | tr -d '[:space:]')
    if ! [[ $test_result = PONG ]] ; then
       echo "Error: CANNOT CONNECT TO REDIS" >> /tmp/redis-test.log ; exit 1
    fi
    echo "Connected To REDIS - Success" >> /tmp/redis-test.log ; exit 0