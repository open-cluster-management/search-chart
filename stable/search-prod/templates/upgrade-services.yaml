# Licensed Materials - Property of IBM
# (C) Copyright IBM Corporation 2019 All Rights Reserved
# US Government Users Restricted Rights - Use, duplication or disclosure restricted by GSA ADP Schedule Contract with IBM Corp.

# apiVersion: batch/v1
# kind: Job
# metadata:
#   name: {{ template "search.fullname" . }}-upgrade-services
#   namespace: {{ .Release.Namespace }}
#   annotations:
#     "helm.sh/hook": pre-upgrade,pre-install
#     "helm.sh/hook-delete-policy": hook-succeeded
#   labels:
#     app: {{ template "search.name" . }}
#     component: "search"
#     release: {{ .Release.Name }}
#     chart: {{ template "search.chart" . }}
#     hertage: {{ .Release.Service }}
#     app.kubernetes.io/instance: {{ template "search.fullname" . }}
#     app.kubernetes.io/managed-by: {{ template "search.managedBy" .}}
#     app.kubernetes.io/name: {{ template "search.fullname" . }}-upgrade-services
#     helm.sh/chart: {{ template "search.chart" . }}
# spec:
#   template:
#     metadata:
#       name: {{ template "search.fullname" . }}-upgrade-services
#       labels:
#         app: {{ template "search.name" . }}
#         component: "search"
#         release: {{ .Release.Name }}
#         chart: {{ template "search.chart" . }}
#         heritage: {{ .Release.Service }}
#         app.kubernetes.io/instance: {{ template "search.fullname" . }}
#         app.kubernetes.io/managed-by: {{ template "search.managedBy" .}}
#         app.kubernetes.io/name: {{ template "search.fullname" . }}-upgrade-services
#         helm.sh/chart: {{ template "search.chart" . }}
#     spec:
#       affinity:
#         nodeAffinity:
#           requiredDuringSchedulingIgnoredDuringExecution:
#             nodeSelectorTerms:
#             - matchExpressions:
#               - key: beta.kubernetes.io/arch
#                 operator: In
#                 values:
#                 {{- range .Values.global.arch }}
#                 - {{ . }}
#                 {{- end }}
#       tolerations:
#         - key: dedicated
#           operator: Exists
#           effect: NoSchedule
#       containers:
#         - name: kubectl
#           image: "{{ .Values.kubectl.repository }}:{{ .Values.kubectl.tag }}"
#           imagePullPolicy: "{{ .Values.kubectl.pullPolicy }}"
#           securityContext:
#             privileged: false
#             readOnlyRootFilesystem: false
#             allowPrivilegeEscalation: false
#             runAsNonRoot: true
#             runAsUser: 1000
#             capabilities:
#               drop:
#               - ALL
#           command: ["/bin/bash", "-c", "kubectl delete service -l 'component in (mcm-search,search-aggregator)'" ]
#           resources:
#             requests:
#               memory: "64Mi"
#               cpu: "25m"
#             limits:
#               memory: "512Mi"
#               cpu: "50m"
#       hostIPC: false
#       hostNetwork: false
#       hostPID: false
#       restartPolicy: OnFailure
#       {{- if .Values.global.pullSecret }}
#       imagePullSecrets:
#       - name: {{ .Values.global.pullSecret }}
#       {{- end }}
